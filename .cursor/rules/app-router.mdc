---
description: Padrões para pages e layouts do App Router — Server Components, params, Suspense
globs: src/app/**/*.tsx
alwaysApply: false
---

# App Router — Padrões

## Server Component por padrão

- Pages são Server Components — sem `'use client'` a menos que necessário
- Buscar dados diretamente nas pages, sem `useEffect` + fetch

```tsx
// ✅ Server Component buscando dados diretamente
export default async function BookPage({ params }: Props) {
  const { title } = await params
  const highlights = await getHighlightsByBook(decodeURIComponent(title))
  return <HighlightList highlights={highlights} />
}
```

## params é uma Promise no Next.js 15

- Sempre `await params` antes de acessar propriedades

```tsx
// ❌ quebra no Next.js 15
export default async function Page({ params }: { params: { title: string } }) {
  const title = params.title // erro — params é Promise

// ✅
type Props = { params: Promise<{ title: string }> }

export default async function Page({ params }: Props) {
  const { title } = await params
```

## useSearchParams requer Suspense

- Qualquer Client Component que usa `useSearchParams()` deve estar dentro de `<Suspense>`

```tsx
// ✅ em page.tsx
import { Suspense } from 'react'

<Suspense fallback={<div style={{ height: '2.5rem' }} />}>
  <SearchBar />
</Suspense>
```

## generateMetadata

- Toda page dinâmica deve ter `generateMetadata` com título descritivo

```tsx
export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { title } = await params
  return {
    title: `${decodeURIComponent(title)} — Kindle Vault`,
  }
}
```

## decodeURIComponent

- Sempre dentro de try/catch em params de URL

```tsx
let bookTitle: string
try {
  bookTitle = decodeURIComponent(title)
} catch {
  notFound()
}
```

## export default — exceção obrigatória do App Router

`page.tsx` e `layout.tsx` do Next.js App Router exigem `export default`.
Esta é a única exceção à regra de named exports do projeto.

```tsx
// ✅ obrigatório no App Router
export default function Page() { ... }
export default function Layout() { ... }

// ✅ em todo o resto — named export
export function MyComponent() { ... }
export function useMyHook() { ... }
```

---

Adicionar no final do arquivo, após a última seção existente:

```md
---

## Dark Mode — FOUC de navegação vs primeira carga

São dois problemas distintos com causas e fixes diferentes:

**FOUC de primeira carga** — resolvido por script anti-FOUC síncrono no `<head>`:
```ts
// src/app/layout.tsx
<script dangerouslySetInnerHTML={{ __html: themeScript }} />
```

**FOUC de navegação** (flash ao trocar de rota) — resolvido lendo o cookie
no servidor e aplicando a classe `dark` diretamente no `<html>`:
```tsx
// src/app/layout.tsx
import { cookies } from 'next/headers'

const cookieStore = await cookies()
const isDark = cookieStore.get('THEME')?.value === 'dark'

<html className={isDark ? 'dark' : ''} suppressHydrationWarning>
```

O root layout não é recriado entre navegações — a classe `dark` persiste
em todas as rotas sem depender do cliente.

`suppressHydrationWarning` é obrigatório no `<html>` porque o servidor
não conhece `prefers-color-scheme` — pode haver diferença entre
o HTML do servidor e o estado do cliente na primeira visita.
```

## layout.tsx

- `<html lang={DEFAULT_LOCALE}  className={isDark ? 'dark' : ''}>` obrigatório
- Fontes carregadas via `next/font/google` — nunca via `<link>` no head
